#MongoDB 스토어 개발 및 테스트

이 장에서는 먼저 MongoDB의 데이터 모델링 시 고려사항을 살펴본다. 그 다음 MEAN Stack 커뮤니티 서비스의 데이터 모델을 Mongoose를 이용하여 스키마를 디자인하고 마지막으로 Node의 테스트 프레임웍인 Mocha로 단위테스트를 만들고 실행하는 과정을 다룬다.

아직 MongoDB가 익숙치 않은 독자라면 어떻게 데이터 모델링을 해야 할 지 막연할 수 있다. 또한 내가 만든 데이터 모델이 적합한 것인지 확신을 갖지 못할 수도 있다. 이러한 의문에 대한 답을 찾으려면 실제 코딩을 하면서 확인을 하는 것이 가장 빠른 방법이다.

MongoDB는 자바스크립트로 코드로 실행할 수 있는 mongo Shell을 제공한다. mongo Shell을 통하여 효과적으로 데이터를 질의하고 수정하는 방법을 알 수 있다. 또한 로그를 확인하고 모니터링을 할 수 있으므로 필히 사용법을 익혀두기 바란다. 또한 대부분의 MongoDB 드라이버는 mongo Shell와 유사한 인터페이스를 갖고 있으므로 애플리케이션 개발 시에도 유용하다. mongo Shell의 사용법은 부록을 참고하기 바란다.

##데이터 모델링

MongoDB의 데이터 모델링은 새로운 관점으로 접근해야 한다. 기존 관계형 데이터베이스는 데이터를 분석하여 데이터 모델링을 했다면 MongoDB는 데이터 뿐만 아니라 애플리케이션에 따라서도 데이터 모델링을 다르게 해야 한다. 전통적으로 데이터 모델링이 계획 및 설계 단계에서 대부분 이루어졌다면 MongoDB는 애플리케이션 생애주기 동안 지속적으로 데이터 모델을 개선한다. 

MongoDB 데이터 모델링시 고려사항은 첫째 데이터의 질의이다. 앞서 언급했듯이 MongoDB에서 질의와 수정은 어떻게 하는 것이 효과적인지 알아야 최적의 데이터 모델을 설계할 수 있다. 간혹 하나의 도큐먼트에서 모든 개체의 관계를 표현하는 것을 볼 수 있는데 이런 경우는 질의와 수정을 어렵고 좋은 성능을 기대 할 수 없다. 기본적으로 하나의 도큐먼트의 크기는 100KB 이하로 하는 것이 좋고 너무 많이 중첩된 도큐먼트는 별도로 컬렉션을 만들어 데이터를 나누어야 한다.

둘째 읽기와 쓰기의 비율이다. 읽기의 빈도가 많다면 인덱스를 적절히 사용할 수 있도록 모델링해야 한다. 때에 따라선 역정규화도 필요하다. 쓰기가 빈번한 애플리케이션에서는 insert() 연산을 이용하고 업데이트는 가급적 도큐먼트를 디스크에 다시 쓰지 않도록 크기가 많이 변경되지 않도록 하여야 한다.

셋째 데이터의 증가량이다. 만약 컬렉션을 샤딩을 해야할 정도로 데이터의 증가가 예상된다면 적절한 샤드키를 정의할 수 있도록 해야 한다. 

##디자인 패턴 

많은 개발자가 MongoDB도 관계형 데이터베이스처럼 잘 정의된 모델링 기법이나 절차에 대해 궁금해한다. 하지만 아직까지 체계화된 방법은 없다. 그리고 애플리케이션에 따라서 모델링이 달라지기 때문에 무엇이 정답이라 하기 어려운 것도 사실이다. 하지만 일반적으로 많이 쓰는 패턴을 살펴보면 시작하는데 도움이 된다.

###임베드 대 레퍼런스 

###일대다 

###다대다

###트리

###원자적 수정

##Mongoose를 이용한 스키마 디자인

##테스트
